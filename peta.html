<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Peta Pelayanan Wilayah 6 | PDAM Tirtawening</title>

<!-- LIBRARIES -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"></script>

<style>
body {
  margin: 0;
  font-family: "Poppins", sans-serif;
  background: #0b1f3b;
  overflow: hidden;
  color: #fff;
}

/* Navbar */
.navbar {
  background: rgba(11,31,59,0.8);
  backdrop-filter: blur(12px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
.navbar-brand {
  color: #4db8ff !important;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}
.navbar .btn-panel {
  background: rgba(255,255,255,0.1);
  border: none;
  border-radius: 8px;
  color: #4db8ff;
  padding: 6px 12px;
}
.navbar .btn-panel:hover {
  background: #4db8ff;
  color: #0b1f3b;
}

/* Map */
#map {
  height: 100vh;
  width: 100%;
  z-index: 1;
}

/* Sidebar glass */
#sidebar {
  position: fixed;
  top: 70px;
  right: -360px;
  width: 360px;
  height: calc(100vh - 70px);
  background: rgba(16,40,78,0.7);
  backdrop-filter: blur(12px);
  border-left: 1px solid rgba(255,255,255,0.1);
  border-top-left-radius: 20px;
  box-shadow: -2px 0 12px rgba(0,0,0,0.3);
  color: #fff;
  padding: 15px;
  transition: right 0.5s ease;
  z-index: 10000;
  display: flex;
  flex-direction: column;
}
#sidebar.active { right: 0; }

/* Sidebar tabs */
.tab-header {
  display: flex;
  justify-content: space-around;
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 6px;
  margin-bottom: 10px;
}
.tab-btn {
  flex: 1;
  text-align: center;
  padding: 8px;
  font-size: 14px;
  color: #ccc;
  cursor: pointer;
  border-radius: 8px;
  transition: 0.3s;
}
.tab-btn.active {
  background: #4db8ff;
  color: #0b1f3b;
  font-weight: 600;
}

/* Tab content */
.tab-content {
  flex: 1;
  overflow-y: auto;
  padding-top: 10px;
}
.tab-pane { display: none; }
.tab-pane.active { display: block; animation: fadeIn 0.4s ease; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Marker cluster style */
.marker-cluster-small,
.marker-cluster-medium,
.marker-cluster-large {
  background: rgba(77,184,255,0.2);
  border: 1px solid #4db8ff;
  border-radius: 50%;
  color: #fff;
}

/* Popup card */
.popup-card {
  background: rgba(16,40,78,0.95);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  color: #fff;
  font-size: 13px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  width: 300px;
  overflow: hidden;
}
.popup-header {
  background: rgba(255,255,255,0.1);
  padding: 8px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.popup-body { padding: 10px 12px; }
.popup-tabs {
  display: flex;
  justify-content: space-between;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.popup-tab {
  flex: 1;
  text-align: center;
  cursor: pointer;
  padding: 5px;
  color: #aaa;
}
.popup-tab.active {
  color: #4db8ff;
  border-bottom: 2px solid #4db8ff;
}

/* Table mini */
.popup-table {
  width: 100%;
  font-size: 12px;
  border-collapse: collapse;
}
.popup-table td {
  padding: 4px 6px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.popup-table td:first-child { color: #4db8ff; width: 40%; }

/* Animasi & scrollbar */
#sidebar ::-webkit-scrollbar { width: 6px; }
#sidebar ::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 6px;
}
</style>
</head>
<body>
<nav class="navbar navbar-dark px-4">
  <a class="navbar-brand" href="#">
    <img src="https://perumdatirtawening.co.id/asset/image/logo-horizon-kecils.gif" height="40" alt="" />
    Peta Pelayanan Wilayah 6
  </a>
  <button class="btn-panel" id="togglePanel"><i class="fas fa-gear"></i> Panel</button>
</nav>

<div id="map"></div>

<div id="sidebar">
  <div class="tab-header">
    <div class="tab-btn active" data-tab="base"><i class="fas fa-layer-group"></i></div>
    <div class="tab-btn" data-tab="search"><i class="fas fa-search"></i></div>
    <div class="tab-btn" data-tab="pressure"><i class="fas fa-tachometer-alt"></i></div>
    <div class="tab-btn" data-tab="report"><i class="fas fa-bullhorn"></i></div>
  </div>
  <div class="tab-content">
    <div class="tab-pane active" id="base">
      <h6>üó∫Ô∏è Pilih Basemap</h6>
      <button class="btn btn-sm btn-primary w-100 mb-2" id="lightBtn">Peta Terang</button>
      <button class="btn btn-sm btn-secondary w-100 mb-2" id="darkBtn">Peta Gelap</button>
      <button class="btn btn-sm btn-success w-100" id="satBtn">Peta Satelit</button>
    </div>
    <div class="tab-pane" id="search">
      <h6>üîç Cari Pelanggan</h6>
      <input type="text" class="form-control mb-2" id="searchNama" placeholder="Masukkan nama atau nomor" />
      <button class="btn btn-info w-100" id="btnCari">Cari</button>
    </div>
    <div class="tab-pane" id="pressure">
      <h6>üíß Tekanan Air Realtime</h6>
      <table class="table table-sm text-white" id="tblTekanan">
        <thead><tr><th>Sensor</th><th>Tekanan</th><th>Waktu</th></tr></thead>
        <tbody><tr><td colspan="3">Memuat data...</td></tr></tbody>
      </table>
    </div>
    <div class="tab-pane" id="report">
      <h6>üì£ Daftar Pengaduan</h6>
      <div id="aduanList" style="font-size:13px;line-height:1.4;">Memuat data...</div>
    </div>
  </div>
</div>
<script>
// =======================
// ‚öôÔ∏è SIDEBAR CONTROL
// =======================
const sidebar = document.getElementById('sidebar');
document.getElementById('togglePanel').addEventListener('click', () => {
  sidebar.classList.toggle('active');
});
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

// =======================
// üåç MAP CONFIGURATION
// =======================
const map = L.map('map', {
  zoomAnimation: true,
  markerZoomAnimation: true,
  fadeAnimation: true,
  inertia: true,
  inertiaDeceleration: 2000
}).setView([-6.9457,107.6093],13);

const baseLayers = {
  light: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'),
  sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
};
baseLayers.light.addTo(map);
document.getElementById('lightBtn').onclick=()=>setBase('light');
document.getElementById('darkBtn').onclick=()=>setBase('dark');
document.getElementById('satBtn').onclick=()=>setBase('sat');

function setBase(mode){
  for(let k in baseLayers){ if(map.hasLayer(baseLayers[k])) map.removeLayer(baseLayers[k]); }
  baseLayers[mode].addTo(map);
}

// =======================
// üì° ENDPOINTS
// =======================
const endpoints = {
  pelanggan: "https://script.google.com/macros/s/AKfycbyag2N0JGG9EJvGYsoGqmZeR0H1j2KiK6dQ0eprnzz5WV4j32G6qwgRmz8RzAl6i7aj6w/exec?mode=pelanggan",
  pngaduan: "https://script.google.com/macros/s/AKfycbyag2N0JGG9EJvGYsoGqmZeR0H1j2KiK6dQ0eprnzz5WV4j32G6qwgRmz8RzAl6i7aj6w/exec?mode=pengaduan",
  tekanan: "https://api.thingspeak.com/channels/3102639/feeds.json?results=5",
  pipa: "https://script.google.com/macros/s/AKfycbyag2N0JGG9EJvGYsoGqmZeR0H1j2KiK6dQ0eprnzz5WV4j32G6qwgRmz8RzAl6i7aj6w/exec?mode=pipa",
  wilayah: "https://script.google.com/macros/s/AKfycbyag2N0JGG9EJvGYsoGqmZeR0H1j2KiK6dQ0eprnzz5WV4j32G6qwgRmz8RzAl6i7aj6w/exec?mode=wilayah",
  logger: "https://script.google.com/macros/s/AKfycbyag2N0JGG9EJvGYsoGqmZeR0H1j2KiK6dQ0eprnzz5WV4j32G6qwgRmz8RzAl6i7aj6w/exec?mode=logger",
  histori: "https://script.google.com/macros/s/AKfycbyag2N0JGG9EJvGYsoGqmZeR0H1j2KiK6dQ0eprnzz5WV4j32G6qwgRmz8RzAl6i7aj6w/exec?mode=histori&id="
};

// =======================
// üß© GLOBAL LAYER CLUSTER
// =======================
const clusterGroup = L.markerClusterGroup({
  spiderfyOnEveryZoom: false,
  showCoverageOnHover: false,
  disableClusteringAtZoom: 17
});
map.addLayer(clusterGroup);

const canvasRenderer = L.canvas({ padding: 0.5 });

let pelangganLayer;
const markers = []; // üü¢ array global untuk semua marker pelanggan

baseLayers.light.addTo(map);

async function loadData() {
  const res = await fetch(endpoints.pelanggan);
  const data = await res.json();
  if (pelangganLayer) map.removeLayer(pelangganLayer);

  pelangganLayer=L.geoJSON(data,{
    pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:7,fillColor:"#4db8ff",color:"#fff",weight:1,fillOpacity:0.9}),
    onEachFeature:(f,layer)=>{
      const p=f.properties;
      const statusClass=(p["Status Planggan"]||"").toLowerCase().includes("nunggak")?"tunggakan":"sudah";
      

      const popupHTML=`
        <div class="popup-card">
          <div class="popup-header">
            <h3>${p.Nama||"Pelanggan"} <small>${p.ID||""}</small></h3>
            <a class="menuju-lokasi" target="_blank" href="https://www.google.com/maps?q=${p.Latitude},${p.Longtitude}">üìç Menuju Lokasi</a>
          </div>
          <div class="popup-body">
            <div class="popup-status">
              <div>Pemakaian: <b>${formatMeterKubik(p.Pemakaian)}</b></div>
              <div class="status-label ${statusClass}">${p["Status Planggan"]||"Belum Terbayar"}</div>
              
            </div>
            <div class="popup-tab">
              <div class="tab-btn active" data-tab="detail">Pelanggan</div>
              <div class="tab-btn" data-tab="tagihan">Tagihan</div>
              <div class="tab-btn" data-tab="foto">Foto</div>
            </div>
            <div class="popup-section active" id="detail">
              <table>
                <tr><td>Alamat</td><td>${p.Alamat||"-"}</td></tr>
                <tr><td>Kelurahan</td><td>${p.Kelurahan||"-"}</td></tr>
                <tr><td>Kecamatan</td><td>${p.Kecamatan||"-"}</td></tr>
              </table>
            </div>
            <div class="popup-section" id="tagihan">
              <table>
                <tr><td>Tagihan</td><td>${formatRupiah(p.Tagihan)}</td></tr>
                <tr><td>Status</td><td>${p.StatusBilling||"-"}</td></tr>
                <tr><td>Tunggakan</td><td>${formatRupiah(p.Tunggakan)}</td></tr>
                <tr><td>Keterangan Cater</td><td>${p.Ketcatat||"-"}</td></tr>

              </table>
            </div>
            <div class="popup-section" id="foto">
              ${p["Foto Rumah"]?`<img src="${p["Foto Rumah"]}" style="width:100%;border-radius:8px;">`:"<p>Tidak ada foto.</p>"}
            </div>
          </div>
        </div>`;
      layer.bindPopup(popupHTML);

      // üü¢ simpan nama ke marker
      if (p.Nama) {
        layer.nama = p.Nama.toLowerCase();
        markers.push(layer);
      }

      // aktifkan tab popup
      layer.on("popupopen",()=>{
        const popup=layer.getPopup().getElement();
        const tabs=popup.querySelectorAll(".tab-btn");
        const sections=popup.querySelectorAll(".popup-section");
        tabs.forEach(btn=>{
          btn.addEventListener("click",()=>{
            tabs.forEach(b=>b.classList.remove("active"));
            btn.classList.add("active");
            sections.forEach(s=>s.classList.remove("active"));
            popup.querySelector(`#${btn.dataset.tab}`).classList.add("active");
          });
        });
      });
    }
  }).addTo(map);
  map.fitBounds(pelangganLayer.getBounds());
// üî¢ Format angka ke satuan m¬≥ (meter kubik)
function formatMeterKubik(angka) {
  if (!angka || isNaN(angka)) return "0 m¬≥";
  return Number(angka).toLocaleString("id-ID") + " m¬≥";
}
}
loadData();
<!-- === üîπ PELANGGAN INTEGRATION === -->
async function loadPelanggan() {
  try {
    const res = await fetch(endpoints.pelanggan);
    const geojson = await res.json();

    // hapus layer lama jika ada
    if (window.layerPelanggan) map.removeLayer(window.layerPelanggan);

    // buat layer baru
    window.layerPelanggan = L.geoJSON(geojson, {
      pointToLayer: (feature, latlng) => {
        const statusAduan = feature.properties["Status Aduan"] || "Normal";
        const warna = statusAduan === "Baru" ? "#ff4d4d" : "#4db8ff";
        return L.circleMarker(latlng, {
          radius: 7,
          fillColor: warna,
          color: "#fff",
          weight: 1,
          fillOpacity: 0.9
        });
      },
      onEachFeature: (feature, layer) => {
        const p = feature.properties;
        const historiLink = `${endpoints.histori}&id=${encodeURIComponent(p["Nomor Pelanggan"])}`;

        const html = `
          <div class="popup-card">
            <div class="popup-header">
              <h3>${p["Nama Pelanggan"] || "Pelanggan"} <small>${p["Nomor Pelanggan"] || ""}</small></h3>
              <a href="https://www.google.com/maps?q=${p.Latitude},${p.Longtitude}" target="_blank" style="font-size:12px;color:#4db8ff;text-decoration:none;">üìç Lihat Lokasi</a>
            </div>
            <div class="popup-body">
              <table class="popup-table">
                <tr><td>Alamat</td><td>${p["Alamat"] || "-"}</td></tr>
                <tr><td>Kelurahan</td><td>${p["Kelurahan"] || "-"}</td></tr>
                <tr><td>Kecamatan</td><td>${p["Kecamatan"] || "-"}</td></tr>
                <tr><td>Tagihan</td><td>${formatRupiah(p["Tagihan"]) || "-"}</td></tr>
                <tr><td>Status Aduan</td><td>${p["Status Aduan"] || "Normal"}</td></tr>
              </table>
              ${p["Foto Rumah"] ? `<img src="${p["Foto Rumah"]}" style="width:100%;border-radius:8px;margin-top:8px;">` : ""}
              ${p["Foto Aduan"] ? `<img src="${p["Foto Aduan"]}" style="width:100%;border-radius:8px;margin-top:8px;">` : ""}
              <div id="histori-${p["Nomor Pelanggan"]}" style="margin-top:8px;font-size:12px;color:#ccc;">‚è≥ Memuat histori...</div>
            </div>
          </div>
        `;
        layer.bindPopup(html);

        // ambil histori saat popup dibuka
        layer.on("popupopen", async () => {
          const el = document.getElementById(`histori-${p["Nomor Pelanggan"]}`);
          if (!el) return;
          try {
            const hRes = await fetch(historiLink);
            const hData = await hRes.json();
            if (!hData.length) {
              el.innerHTML = "‚ùå Tidak ada histori.";
            } else {
              const rows = hData.map(h => `<tr><td>${h.Bulan}</td><td>${h.Pemakaian} m¬≥</td><td>${formatRupiah(h.Tagihan)}</td></tr>`).join("");
              el.innerHTML = `
                <table style="width:100%;font-size:11px;color:#eee;border-collapse:collapse;margin-top:4px;">
                  <thead><tr><th>Bulan</th><th>Pakai</th><th>Tagihan</th></tr></thead>
                  <tbody>${rows}</tbody>
                </table>
              `;
            }
          } catch (err) {
            el.innerHTML = "‚ö†Ô∏è Gagal ambil histori.";
          }
        });
      }
    }).addTo(map);

    // auto zoom biar fit area pelanggan
    map.fitBounds(window.layerPelanggan.getBounds());
  } catch (err) {
    console.error("‚ùå Gagal load pelanggan:", err);
  }
}

// format helper
function formatRupiah(angka) {
  if (!angka || isNaN(angka)) return "Rp 0";
  return "Rp " + Number(angka).toLocaleString("id-ID");
}

// panggil pertama kali
loadPelanggan();
// auto-refresh setiap 1 menit
setInterval(loadPelanggan, 60000);
</script>
<!-- === üîπ WILAYAH INTEGRATION === -->
<script>
async function loadWilayah() {
  try {
    const res = await fetch(endpoints.wilayah);
    const data = await res.json();

    // hapus layer lama jika ada
    if (window.layerWilayah) map.removeLayer(window.layerWilayah);

    // tambahkan layer wilayah
    window.layerWilayah = L.geoJSON(data, {
      style: {
        color: "#4db8ff",
        weight: 2,
        fillColor: "#4db8ff",
        fillOpacity: 0.15
      },
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const nama = p["Nama Wilayah"] || p["Wilayah"] || "Wilayah Tanpa Nama";
        const petugas = p["Petugas"] || "-";
        const keterangan = p["Keterangan"] || "";

        layer.bindPopup(`
          <div class="popup-card">
            <div class="popup-header">
              <h3>üó∫Ô∏è ${nama}</h3>
            </div>
            <div class="popup-body">
              <p><b>Petugas:</b> ${petugas}</p>
              <p><b>Keterangan:</b> ${keterangan}</p>
            </div>
          </div>
        `);
      }
    }).addTo(map);

    console.log("‚úÖ Wilayah dimuat:", data.features?.length || data.length);
  } catch (err) {
    console.error("‚ùå Gagal load wilayah:", err);
  }
}

// Panggil pertama kali
loadWilayah();

// Auto-refresh setiap 2 menit
setInterval(loadWilayah, 120000);
<!-- === üîπ WILAYAH GEOJSON INTEGRATION === -->

async function loadWilayahGeoJSON() {
  try {
    // Ganti URL ini dengan link GeoJSON kamu
    const res = await fetch("DMA.geojson");
    const data = await res.json();

    if (window.layerWilayah) map.removeLayer(window.layerWilayah);

    window.layerWilayah = L.geoJSON(data, {
      style: {
        color: "#4db8ff",
        weight: 2,
        fillColor: "#4db8ff",
        fillOpacity: 0.15
      },
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        layer.bindPopup(`
          <div class="popup-card">
            <div class="popup-header"><h3>üó∫Ô∏è ${p.name || "Wilayah Tanpa Nama"}</h3></div>
            <div class="popup-body">
              <p><b>Kordinator:</b> ${p.KORDINATOR || "-"}</p>
              <p><b>DMA:</b> ${p.DMA || "-"}</p>
              <p><b>Eksisting:</b> ${p.EKSISTING || "-"}</p>
              <p><b>Potensi:</b> ${p.POTENSI || "-"}</p>
              <p><b>Luas:</b> ${p.Luas || "-"}</p>
            </div>
          </div>
        `);
      }
    }).addTo(map);

    console.log("‚úÖ Wilayah GeoJSON dimuat:", data.features?.length);
  } catch (err) {
    console.error("‚ùå Gagal load GeoJSON wilayah:", err);
  }
}

// panggil saat halaman load
loadWilayahGeoJSON();
setInterval(loadWilayahGeoJSON, 500); // tiap 2 menit
<!-- === üîπ PIPA GEOJSON (UTM ‚Üí WGS84) INTEGRATION === -->

// fungsi konversi koordinat UTM Zone 48S ke LatLng (pakai rumus manual)
function utmToLatLng(easting, northing) {
  const a = 6378137.0;
  const e = 0.081819191;
  const k0 = 0.9996;
  const zoneNumber = 48;
  const southernHemisphere = true;

  const e1sq = e * e / (1 - e * e);
  const x = easting - 500000.0;
  let y = northing;
  if (southernHemisphere) y -= 10000000.0;

  const m = y / k0;
  const mu = m / (a * (1 - e * e / 4 - 3 * e**4 / 64 - 5 * e**6 / 256));

  const phi1Rad = mu
    + (3 * e1sq / 2 - 27 * e1sq**3 / 32) * Math.sin(2 * mu)
    + (21 * e1sq**2 / 16 - 55 * e1sq**4 / 32) * Math.sin(4 * mu)
    + (151 * e1sq**3 / 96) * Math.sin(6 * mu);
  const n1 = a / Math.sqrt(1 - e * e * Math.sin(phi1Rad)**2);
  const t1 = Math.tan(phi1Rad)**2;
  const c1 = e1sq * Math.cos(phi1Rad)**2;
  const r1 = a * (1 - e * e) / Math.pow(1 - e * e * Math.sin(phi1Rad)**2, 1.5);
  const d = x / (n1 * k0);

  const lat = phi1Rad - (n1 * Math.tan(phi1Rad) / r1) * (
    d * d / 2
    - (5 + 3 * t1 + 10 * c1 - 4 * c1**2 - 9 * e1sq) * Math.pow(d, 4) / 24
    + (61 + 90 * t1 + 298 * c1 + 45 * t1**2 - 252 * e1sq - 3 * c1**2) * Math.pow(d, 6) / 720
  );

  const lon = ((d
    - (1 + 2 * t1 + c1) * Math.pow(d, 3) / 6
    + (5 - 2 * c1 + 28 * t1 - 3 * c1**2 + 8 * e1sq + 24 * t1**2) * Math.pow(d, 5) / 120
  ) / Math.cos(phi1Rad)) + ((zoneNumber - 1) * 6 - 180 + 3) * Math.PI / 180;

  return [lon * 180 / Math.PI, lat * 180 / Math.PI];
}

// ====================================================
// üö∞ Load dan tampilkan layer pipa
// ====================================================
async function loadPipaGeoJSON() {
  try {
    const res = await fetch("pipaexisting.geojson"); // ganti sesuai lokasi file
    const data = await res.json();

    // Konversi UTM ke lat-long
    data.features.forEach(f => {
      if (f.geometry?.coordinates) {
        const newCoords = f.geometry.coordinates.map(line =>
          line.map(([x, y]) => utmToLatLng(x, y))
        );
        f.geometry = { type: "MultiLineString", coordinates: newCoords };
      }
    });

    if (window.layerPipa) map.removeLayer(window.layerPipa);

    window.layerPipa = L.geoJSON(data, {
      style: feature => {
        const p = feature.properties || {};
        const material = (p.material_p || "").toLowerCase();
        const diameter = parseFloat(p.diameter_p) || 0;
        let color = "#4db8ff"; // default biru

        // üé® Warna berdasarkan material
        if (material.includes("pvc")) color = "#00ccff";
        else if (material.includes("besi")) color = "#888888";
        else if (material.includes("hdpe")) color = "#00ff99";

        // üî∏ Atur gradasi kalau mau bedain diameter
        if (diameter >= 200) color = "#ff3333";
        else if (diameter >= 100) color = "#ffa500";

        return { color, weight: 3, opacity: 0.9 };
      },
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        layer.bindPopup(`
          <div class="popup-card">
            <div class="popup-header"><h3>üö∞ ${p.lokasi || "Pipa"}</h3></div>
            <div class="popup-body">
              <p><b>Material:</b> ${p.material_p || "-"}</p>
              <p><b>Diameter:</b> ${p.diameter_p || "-"}</p>
              <p><b>Panjang:</b> ${p.panjang_pi || "-"}</p>
              <p><b>Tahun Pasang:</b> ${p.thn_pasang || "-"}</p>
            </div>
          </div>
        `);
      }
    }).addTo(map);

    console.log("‚úÖ Pipa tampil:", data.features.length);
  } catch (err) {
    console.error("‚ùå Gagal load pipa:", err);
  }
}

loadPipaGeoJSON();
setInterval(loadPipaGeoJSON, 180000); // refresh tiap 3 menit
</script>

</script>

</script>


// üü¢ SEARCH NAMA PELANGGAN
function cariNama() {
  const input = document.getElementById("searchNama").value.toLowerCase();
  if (!input) return;
  const found = markers.find(m => m.nama && m.nama.includes(input));
  if (found) {
    map.flyTo(found.getLatLng(), 17, { duration: 1.2 });
    found.openPopup();
  } else {
    alert("Nama pelanggan tidak ditemukan!");
  }
}
document.getElementById("btnCari").addEventListener("click", cariNama);
document.getElementById("searchNama").addEventListener("keypress", e => {
  if (e.key === "Enter") cariNama();
});

// switch layer
const lightBtn=document.getElementById('lightBtn');
const darkBtn=document.getElementById('darkBtn');
const satBtn=document.getElementById('satBtn');
const allBtns=[lightBtn,darkBtn,satBtn];
function setBase(mode,btn){
  for(let key in baseLayers){if(map.hasLayer(baseLayers[key])) map.removeLayer(baseLayers[key]);}
  if(mode==="light"){baseLayers.light.addTo(map);document.body.className="light";}
  else if(mode==="dark"){baseLayers.dark.addTo(map);document.body.className="dark";}
  else{baseLayers.sat.addTo(map);document.body.className="light";}
}
lightBtn.onclick=()=>setBase("light",lightBtn);
darkBtn.onclick=()=>setBase("dark",darkBtn);
satBtn.onclick=()=>setBase("sat",satBtn);
// üïí AUTO REFRESH SETIAP 1 MENIT TANPA TAMPILAN
setInterval(() => {
  console.log("‚ü≥ Auto-refresh data pelanggan...");
  loadData(); // panggil ulang data
}, 60000); // 60000 ms = 1 menit

</script>
<!-- üîî Tambah elemen suara & toast -->
<audio id="notifSound" preload="auto">
  <source src="https://assets.mixkit.co/sfx/download/mixkit-correct-answer-tone-2870.wav" type="audio/wav">
</audio>

<style>
/* Toast Notification Style */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #0078FF;
  color: white;
  padding: 12px 18px;
  border-radius: 8px;
  font-family: "Poppins", sans-serif;
  font-size: 13px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.4s ease;
  z-index: 9999;
}
.toast.show {
  opacity: 1;
  transform: translateY(0);
}

/* Blinking marker */
.blink-marker {
  animation: blink 1.5s infinite ease-in-out;
}
@keyframes blink {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.2); }
}
</style>

<script>
// üîπ Global untuk simpan tiket baru
let shownTickets = new Set();

// üîπ Fungsi buat tampilkan toast
function showToast(message) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add("show"), 100);
  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 500);
  }, 4000);
}

// üîπ Fungsi main popup aduan
function popupAduan(p) {
  const status = p.Status || "Baru";
  const statusClass =
    status === "Baru" ? "status-baru" :
    status === "Proses" ? "status-proses" :
    "status-selesai";
  const id = p.Tiket || Math.random().toString(36).substring(2,7);

  return `
    <div class="${status === "Baru" ? "blink-marker" : ""}">
      <div class="popup-card">
        <div class="popup-header" style="display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;font-size:15px;color:#0078FF;">
            ${p["Nama Pelanggan"] || "Pelanggan"}
            <small style="color:#999;font-size:12px;">${p.Tiket || ""}</small>
          </h3>
          <a href="https://www.google.com/maps?q=${p["Lokasi Gangguan"]}"
             target="_blank"
             style="font-size:12px;color:#0078FF;text-decoration:none;">üìç Lokasi</a>
        </div>

        <div class="popup-tabs" style="display:flex;margin-top:8px;border:1px solid #ddd;border-radius:6px;overflow:hidden;">
          <div class="popup-tab-btn active" data-tab="detail-${id}" style="flex:1;text-align:center;font-size:12px;padding:4px;cursor:pointer;">üßæ Detail</div>
          <div class="popup-tab-btn" data-tab="keterangan-${id}" style="flex:1;text-align:center;font-size:12px;padding:4px;cursor:pointer;">üí¨ Keterangan</div>
        </div>

        <div id="detail-${id}" class="popup-content">
          <p style="margin:2px 0 8px 0;color:#777;font-size:12px;font-style:italic;">
          ${p.Tanggal ? new Date(p.Tanggal).toLocaleString("id-ID", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
          timeZone: "Asia/Jakarta"
        }) + " WIB"
      : "-"
  } <span style="padding:3px 8px;border-radius:6px;font-size:12px;font-weight:600;
              background:${
                status==="Baru"?"#ffebee":status==="Proses"?"#fff6da":"#e8f5e9"
              };
              color:${
                status==="Baru"?"#e53935":status==="Proses"?"#f9a825":"#2e7d32"
              };">${status}</span>
</p>
          <div><b>Jenis Keluhan:</b> ${p["Jenis Keluhan"] || "-"}</div>
           <div><b>NoLan:</b> ${p["NomorPelanggan"] || "-"}</div>
          <div><b>Telpon:</b> ${p["Nomor Kontak"] || "-"}</div>
          <div><b>Alamat:</b> ${p["Alamat"] || "-"}</div>
        </div>

        <div id="keterangan-${id}" class="popup-content hide" style="display:none;">
          <b>Keluhan:</b><br>
          <div style="white-space:pre-wrap;margin-bottom:6px;">${p["Keterangan"] || "-"}</div>
          ${
            p["Dokumentasi Pengaduan"]
              ? `<img src="${p["Dokumentasi Pengaduan"]}" style="width:100%;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.15);">`
              : `<p style="font-size:12px;color:#888;text-align:center;">Tidak ada foto</p>`
          }
        </div>
      </div>
    </div>
    <script>
      document.querySelectorAll('.popup-tab-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const tabId=btn.getAttribute('data-tab');
          const parent=btn.closest('.popup-card');
          parent.querySelectorAll('.popup-tab-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          parent.querySelectorAll('.popup-content').forEach(c=>c.style.display='none');
          parent.querySelector('#'+tabId).style.display='block';
        });
      });
    <\/script>
  `;
}

// üîπ Fungsi load data pengaduan
async function loadAduan() {
  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbz5ZFftu5HERETjyT25WSdIbz8Va0zqoCv4We3OpDIqi09vpWEO7814ZE2Llu2dNj5kJA/exec?mode=aduan");
    const data = await res.json();
    data.sort((a,b)=>new Date(a.Tanggal)-new Date(b.Tanggal));

    if(window.aduanLayer) map.removeLayer(window.aduanLayer);
    window.aduanLayer = L.layerGroup().addTo(map);

    const audio = document.getElementById("notifSound");

    data.forEach(p=>{
      const lokasi = p["Lokasi Gangguan"];
      const status = p.Status || "";
      if(!lokasi || status==="Selesai") return;

      const [lat,lng] = lokasi.split(",").map(Number);
      if(isNaN(lat)||isNaN(lng)) return;

      // üîî Deteksi tiket baru
      if(!shownTickets.has(p.Tiket)){
        shownTickets.add(p.Tiket);
        if(status==="Baru"){
          audio.currentTime = 0;
          audio.play().catch(()=>{});
          showToast(`üîî Aduan baru: ${p["Nama Pelanggan"] || "Pelanggan"} (${p.Tiket})`);
        }
      }

      const warna = status==="Baru"?"#ff3333":status==="Proses"?"#FFD93D":"#2ECC71";
      const iconHTML = `
        <div class="${status==="Baru"?"blink-marker":""}"
             style="width:18px;height:18px;background:${warna};
             border:2px solid #fff;border-radius:50%;
             box-shadow:0 0 6px rgba(0,0,0,0.4);">
        </div>`;

      const marker = L.marker([lat,lng],{
        icon:L.divIcon({className:"",html:iconHTML,iconSize:[18,18],iconAnchor:[9,9]})
      }).addTo(window.aduanLayer);

      marker.bindPopup(popupAduan(p));
      if(status==="Baru") marker.openPopup();
    });

  } catch(err){
    console.error("‚ùå Gagal memuat data:",err);
  }
}

loadAduan();

// === Aktifin tab Detail / Keterangan di setiap popup ===
map.on("popupopen", (e) => {
  const popupNode = e.popup.getElement();
  if (!popupNode) return;

  const btns = popupNode.querySelectorAll(".popup-tab-btn");
  btns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const tabId = btn.getAttribute("data-tab");
      const parent = btn.closest(".popup-card");
      if (!parent) return;

      // nonaktifin semua tombol
      parent.querySelectorAll(".popup-tab-btn").forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");

      // sembunyikan semua isi tab
      parent.querySelectorAll(".popup-content").forEach((c) => (c.style.display = "none"));
      const showTab = parent.querySelector(`#${tabId}`);
      if (showTab) showTab.style.display = "block";
    });
  });
});


setInterval(loadAduan, 30000);
/* ==========================================================
   üå°Ô∏è LAYER TEKANAN AIR (ambil dari ThingSpeak)
========================================================== */
async function loadTekanan() {
  try {
    const res = await fetch("https://api.thingspeak.com/channels/3102639/feeds.json?results=10");
    const data = await res.json();
    const feeds = data.feeds || [];
    if (window.tekananLayer) map.removeLayer(window.tekananLayer);

    window.tekananLayer = L.layerGroup().addTo(map);

    feeds.forEach((f, i) => {
      const value = parseFloat(f.field1);
      if (isNaN(value)) return;

      // Contoh titik koordinat (ganti sesuai lokasi sensor aslimu)
      const titikSensor = [
        [-6.9457, 107.6093],
        [-6.9490, 107.6125],
        [-6.9522, 107.6060]
      ];

      const lokasi = titikSensor[i % titikSensor.length];
      const warna =
        value < 0.3 ? "#ff4d4d" :
        value < 0.5 ? "#ffcc00" :
        "#00cc66";

      const markerHTML = `
        <div style="
          width:20px;height:20px;border-radius:50%;
          background:${warna};border:2px solid #fff;
          box-shadow:0 0 6px rgba(0,0,0,0.4);">
        </div>`;

      const marker = L.marker(lokasi, {
        icon: L.divIcon({ html: markerHTML, iconSize: [20, 20], className: "" })
      }).addTo(window.tekananLayer);

      const waktu = new Date(f.created_at).toLocaleString("id-ID", {
        day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", timeZone: "Asia/Jakarta"
      });

      marker.bindPopup(`
        <div class="popup-card">
          <div class="popup-header"><h3>Sensor Tekanan ${i + 1}</h3></div>
          <div class="popup-body">
            <p>üíß <b>Tekanan:</b> ${value.toFixed(2)} bar</p>
            <p>üïí ${waktu}</p>
            <a href="https://www.google.com/maps?q=${lokasi[0]},${lokasi[1]}" 
               target="_blank" class="menuju-lokasi">üìç Lihat di Maps</a>
          </div>
        </div>
      `);
    });
  } catch (err) {
    console.error("Gagal load tekanan:", err);
  }
}

// üîÅ Auto refresh tekanan tiap 1 menit
loadTekanan();
setInterval(loadTekanan, 60000);

</script>
<style>
#tekananBox {
  position: absolute;
  bottom: 15px;
  right: 15px;
  background: rgba(255,255,255,0.95);
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  padding: 10px 12px;
  font-family: "Poppins", sans-serif;
  font-size: 12px;
  z-index: 9999;
  width: 250px;
  overflow: hidden;
}
#tekananBox h4 {
  font-size: 13px;
  color: #0078FF;
  text-align: center;
  margin: 0 0 6px;
}
#tblTekanan {
  width: 100%;
  border-collapse: collapse;
}
#tblTekanan th, #tblTekanan td {
  border-bottom: 1px solid #ddd;
  padding: 4px 6px;
  text-align: center;
}
#tblTekanan tbody tr:last-child td { border-bottom: none; }
#tblTekanan td.low { color: #e53935; font-weight: 600; }
#tblTekanan td.mid { color: #f9a825; font-weight: 600; }
#tblTekanan td.ok { color: #2e7d32; font-weight: 600; }
</style>

<script>
async function updateTekananBox() {
  try {
    const res = await fetch("https://api.thingspeak.com/channels/3102639/feeds.json?results=5");
    const data = await res.json();
    const feeds = data.feeds || [];
    const tbody = document.querySelector("#tblTekanan tbody");
    tbody.innerHTML = "";

    feeds.forEach((f, i) => {
      const value = parseFloat(f.field1);
      if (isNaN(value)) return;

      const waktu = new Date(f.created_at).toLocaleTimeString("id-ID", {
        hour: "2-digit", minute: "2-digit", timeZone: "Asia/Jakarta"
      });

      let cls = "ok";
      if (value < 0.3) cls = "low";
      else if (value < 0.5) cls = "mid";

      const row = `
        <tr>
          <td>Sensor ${i + 1}</td>
          <td class="${cls}">${value.toFixed(2)}</td>
          <td>${waktu}</td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", row);
    });

  } catch (err) {
    console.error("Gagal ambil tekanan:", err);
    document.querySelector("#tblTekanan tbody").innerHTML =
      `<tr><td colspan="3">‚ùå Gagal memuat</td></tr>`;
  }
}

updateTekananBox();
setInterval(updateTekananBox, 60000); // refresh tiap 1 menit

</script>
<!-- üîî Notifikasi Tekanan Rendah -->
<div id="alertTekanan"></div>

<style>
#alertTekanan {
  position: absolute;
  top: 70px; /* pas di bawah search box */
  right: 15px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.alert-box {
  background: #ff5252;
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 13px;
  font-family: "Poppins", sans-serif;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  animation: slideIn 0.3s ease, fadeOut 1s ease 5s forwards;
}
@keyframes slideIn {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes fadeOut {
  to { opacity: 0; transform: translateX(20px); }
}
</style>

<script>
// üß† Tambahin fungsi popup alert tekanan rendah
function showLowPressureAlert(sensor, value) {
  const alertBox = document.createElement("div");
  alertBox.className = "alert-box";
  alertBox.innerHTML = `
    ‚ö†Ô∏è <b>Tekanan Rendah!</b><br>
    Sensor ${sensor}: <b>${value.toFixed(2)} bar</b>
  `;
  document.getElementById("alertTekanan").appendChild(alertBox);
  setTimeout(() => alertBox.remove(), 6000);
}

// üîÑ Modifikasi fungsi updateTekananBox dikit biar munculin alert
async function updateTekananBox() {
  try {
    const res = await fetch("https://api.thingspeak.com/channels/3102639/feeds.json?results=5");
    const data = await res.json();
    const feeds = data.feeds || [];
    const tbody = document.querySelector("#tblTekanan tbody");
    tbody.innerHTML = "";

    feeds.forEach((f, i) => {
      const value = parseFloat(f.field1);
      if (isNaN(value)) return;

      const waktu = new Date(f.created_at).toLocaleTimeString("id-ID", {
        hour: "2-digit", minute: "2-digit", timeZone: "Asia/Jakarta"
      });

      let cls = "ok";
      if (value < 0.3) {
        cls = "low";
        showLowPressureAlert(i + 1, value); // üö® panggil popup alert
      } else if (value < 0.5) {
        cls = "mid";
      }

      const row = `
        <tr>
          <td>Sensor ${i + 1}</td>
          <td class="${cls}">${value.toFixed(2)}</td>
          <td>${waktu}</td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", row);
    });

  } catch (err) {
    console.error("Gagal ambil tekanan:", err);
    document.querySelector("#tblTekanan tbody").innerHTML =
      `<tr><td colspan="3">‚ùå Gagal memuat</td></tr>`;
  }
}

updateTekananBox();
setInterval(updateTekananBox, 60000); // refresh tiap 1 menit
</script>
<script>
// üß† PAKAI TOKEN & CHAT ID YANG SAMA DARI PENGADUAN
const BOT_TOKEN = "8353376486:AAET9-fMa_DoYZYA7TF18sGPEYgfMDDqQH4";   // üîÅ sama kayak yang udah lu pakai
const CHAT_ID   = "-4804496689";          // üîÅ chat grup yang sama

// simpan status alert biar ga spam
let sentLowPressure = new Set();

// fungsi kirim ke Telegram
async function kirimTelegram(pesan) {
  try {
    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chat_id: CHAT_ID, text: pesan, parse_mode: "HTML" })
    });
    console.log("‚úÖ Telegram terkirim:", pesan);
  } catch (err) {
    console.error("‚ùå Gagal kirim Telegram:", err);
  }
}

// === üî¥ CEK TEKANAN DARI THINGSPEAK & NOTIF TELEGRAM ===
async function cekTekananRendah() {
  try {
    const res = await fetch("https://api.thingspeak.com/channels/3102639/feeds.json?results=5");
    const data = await res.json();
    const feeds = data.feeds || [];

    // hapus marker tekanan lama
    if (window.tekananAlertLayer) map.removeLayer(window.tekananAlertLayer);
    window.tekananAlertLayer = L.layerGroup().addTo(map);

    feeds.forEach((f, i) => {
      const value = parseFloat(f.field1);
      if (isNaN(value)) return;

      const titikSensor = [
        [-6.9457, 107.6093],
        [-6.9490, 107.6125],
        [-6.9522, 107.6060]
      ];
      const lokasi = titikSensor[i % titikSensor.length];
      const waktu = new Date(f.created_at).toLocaleString("id-ID", {
        day: "2-digit", month: "short", year: "numeric",
        hour: "2-digit", minute: "2-digit", timeZone: "Asia/Jakarta"
      });

      // nilai ambang tekanan
      if (value < 0.3) {
        const iconHTML = `
          <div class="blink-marker" style="width:22px;height:22px;
            border-radius:50%;background:#ff3b3b;border:2px solid #fff;
            box-shadow:0 0 10px rgba(255,0,0,0.6);"></div>`;

        const marker = L.marker(lokasi, {
          icon: L.divIcon({ html: iconHTML, iconSize: [22, 22], className: "" })
        }).addTo(window.tekananAlertLayer);

        // popup tekanan rendah
        marker.bindPopup(`
          <div class="popup-card" style="border:2px solid #ff4444">
            <div class="popup-header" style="background:#ff3b3b;color:#fff;padding:6px 10px;border-radius:8px 8px 0 0">
              ‚ö†Ô∏è <b>Tekanan Rendah</b>
            </div>
            <div class="popup-body" style="padding:8px;font-size:13px;">
              <b>Sensor:</b> ${i + 1}<br>
              <b>Tekanan:</b> <span style="color:#e53935;">${value.toFixed(2)} bar</span><br>
              <b>Waktu:</b> ${waktu}<br>
              <a href="https://www.google.com/maps?q=${lokasi[0]},${lokasi[1]}" target="_blank" style="color:#0078FF;text-decoration:none;">üìç Lihat di Maps</a>
            </div>
          </div>
        `);

        // kirim Telegram cuma sekali
        if (!sentLowPressure.has(i)) {
          sentLowPressure.add(i);
          const msg = `üö® <b>TEKANAN RENDAH TERDETEKSI</b>\nSensor ${i + 1}\nüíß Tekanan: <b>${value.toFixed(2)} bar</b>\nüïí ${waktu}\nüìç https://www.google.com/maps?q=${lokasi[0]},${lokasi[1]}`;
          kirimTelegram(msg);
        }
      } else {
        // reset kalau udah normal, biar bisa kirim lagi nanti
        if (sentLowPressure.has(i)) {
          sentLowPressure.delete(i);
          const msg = `‚úÖ <b>Tekanan Normal Kembali</b>\nSensor ${i + 1} sekarang ${value.toFixed(2)} bar.`;
          kirimTelegram(msg);
        }
      }
    });
  } catch (err) {
    console.error("‚ùå Gagal cek tekanan:", err);
  }
}

// Jalankan awal & refresh tiap 30 detik
cekTekananRendah();
setInterval(cekTekananRendah, 30000);
</script>

</script>
<!-- === üîπ LAYER CONTROL PANEL (FINAL) === -->
<style>
  #layerPanel {
    position: absolute;
    top: 80px;
    right: 20px;
    background: rgba(0,0,0,0.7);
    color: #fff;
    padding: 10px 15px;
    border-radius: 12px;
    font-family: 'Segoe UI', sans-serif;
    z-index: 9999;
    width: 220px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  }
  #layerPanel h3 {
    margin: 0 0 8px 0;
    font-size: 14px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding-bottom: 4px;
  }
  .layer-item {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    font-size: 13px;
  }
  .layer-item input {
    margin-right: 6px;
    transform: scale(1.2);
  }
  .tab-buttons {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
  }
  .tab-buttons button {
    flex: 1;
    background: rgba(255,255,255,0.1);
    border: none;
    color: #fff;
    padding: 5px 0;
    cursor: pointer;
    border-radius: 6px;
    font-size: 12px;
  }
  .tab-buttons button.active {
    background: #2196F3;
  }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
</style>

<div id="layerPanel">
  <div class="tab-buttons">
    <button class="active" data-tab="peta">Peta</button>
    <button data-tab="info">Info</button>
  </div>

  <div id="tab-peta" class="tab-content active">
    <h3>üóÇÔ∏è Layer Peta</h3>
    <div class="layer-item"><input type="checkbox" id="chkPelanggan" checked><label for="chkPelanggan">Pelanggan</label></div>
    <div class="layer-item"><input type="checkbox" id="chkAduan" checked><label for="chkAduan">Pengaduan</label></div>
    <div class="layer-item"><input type="checkbox" id="chkWilayah" checked><label for="chkWilayah">Wilayah</label></div>
    <div class="layer-item">
  <input type="checkbox" id="chkSensor" checked>
  <label for="chkSensor">Sensor</label>
</div>

    <div class="layer-item"><input type="checkbox" id="chkPipa" checked><label for="chkPipa">Pipa</label></div>
    <div class="layer-item"><input type="checkbox" id="chkHistori" checked><label for="chkHistori">Histori</label></div>
  </div>

  <div id="tab-info" class="tab-content">
    <h3>‚ÑπÔ∏è Info</h3>
    <p style="font-size:12px;line-height:1.4em;">
      Gunakan panel ini untuk menampilkan atau menyembunyikan layer di peta.<br><br>
      Pilihan Anda akan disimpan otomatis. Saat data auto-refresh, visibilitas layer tetap sama.  
    </p>
  </div>
</div>

<script>
  // ======== TAB SWITCH ==========
  document.querySelectorAll('.tab-buttons button').forEach(btn => {
    btn.addEventListener('click', e => {
      document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      const tab = e.target.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('tab-' + tab).classList.add('active');
    });
  });

  // ======== LAYER HANDLER ==========
  const layers = {
  pelanggan: () => window.layerPelanggan,
  aduan: () => window.layerAduan,
  sensor: () => window.layerSensor,   // üîπ Tambahin ini
  wilayah: () => window.layerWilayah,
  pipa: () => window.layerPipa,
  histori: () => window.layerHistori
};

  // Simpan status ke localStorage
  function saveLayerState() {
    const state = {};
    Object.keys(layers).forEach(k => {
      const id = 'chk' + k.charAt(0).toUpperCase() + k.slice(1);
      const chk = document.getElementById(id);
      if (chk) state[k] = chk.checked;
    });
    localStorage.setItem('layerState', JSON.stringify(state));
  }

  // Muat ulang status
  function loadLayerState() {
    const state = JSON.parse(localStorage.getItem('layerState') || '{}');
    Object.keys(state).forEach(k => {
      const id = 'chk' + k.charAt(0).toUpperCase() + k.slice(1);
      const chk = document.getElementById(id);
      if (chk) chk.checked = state[k];
    });
  }

  // Terapkan visibilitas
  function applyLayerVisibility() {
    Object.keys(layers).forEach(k => {
      const id = 'chk' + k.charAt(0).toUpperCase() + k.slice(1);
      const chk = document.getElementById(id);
      const layer = layers[k]();
      if (!layer) return;
      if (chk.checked) {
        if (!map.hasLayer(layer)) map.addLayer(layer);
      } else {
        if (map.hasLayer(layer)) map.removeLayer(layer);
      }
    });
  }

  // Event setiap ubah checkbox
  Object.keys(layers).forEach(k => {
    const id = 'chk' + k.charAt(0).toUpperCase() + k.slice(1);
    const chk = document.getElementById(id);
    if (chk) {
      chk.addEventListener('change', () => {
        saveLayerState();
        applyLayerVisibility();
      });
    }
  });

  // Jalankan sinkronisasi awal
  loadLayerState();
  setTimeout(applyLayerVisibility, 1500);

  // Jalankan ulang tiap kali data refresh
  const refreshLayers = ["layerPelanggan","layerAduan","layerWilayah","layerPipa","layerHistori"];
  refreshLayers.forEach(name => {
    const handler = new MutationObserver(() => {
      applyLayerVisibility();
    });
    handler.observe(document.body, { childList: true, subtree: true });
  });
</script>
</body>
</html>
