<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peta Pelanggan PDAM</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html,body{height:100%;margin:0;font-family:"Poppins",sans-serif;transition:background 0.3s ease;}
  body.light{background:#eef2f7;color:#111;}
  body.dark{background:#0b1f3b;color:#fff;}
  #map{height:100%;width:100%;}

  /* switch kiri */
  .switch-container{position:absolute;top:80px;left:10px;z-index:1000;display:flex;flex-direction:column;gap:6px;
    background:rgba(255,255,255,0.9);border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.3);padding:6px;}
  body.dark .switch-container{background:rgba(0,0,0,0.7);}
  .switch-btn{background:transparent;border:none;font-size:1rem;cursor:pointer;border-radius:8px;padding:4px 8px;color:#222;}
  .switch-btn.active{background:#007bff;color:#fff;}
  body.dark .switch-btn{color:#fff;}

  /* Popup card */
  .popup-card{width:320px;background:#fff;border-radius:12px;overflow:hidden;
    box-shadow:0 4px 10px rgba(0,0,0,0.3);color:#000;font-size:0.85rem;}
  body.dark .popup-card{background:#10233f;color:#f2f2f2;}
  .popup-header{padding:10px 12px 4px;border-bottom:1px solid #ddd;}
  .popup-header h3{margin:0;font-size:1.05rem;font-weight:600;}
  .popup-header small{color:#777;}
  .menuju-lokasi{display:inline-block;font-size:0.75rem;background:#c5f6c5;color:#2e7d32;border-radius:20px;
    padding:3px 10px;margin-top:4px;text-decoration:none;}
  .popup-body{padding:10px 12px;}
  .popup-status{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
  .status-label{padding:2px 8px;border-radius:10px;font-size:0.75rem;color:#fff;}
  .belum{background:#f4b400;}
  .tunggakan{background:#d93025;}

  .popup-tab{display:flex;border-bottom:1px solid #ccc;font-size:0.8rem;margin-bottom:6px;}
  .popup-tab div{flex:1;text-align:center;padding:6px 0;cursor:pointer;}
  .popup-tab div.active{color:#4caf50;font-weight:600;border-bottom:2px solid #4caf50;}
  .popup-section{display:none;}
  .popup-section.active{display:block;}

  .popup-section table{width:100%;border-collapse:collapse;font-size:0.8rem;}
  .popup-section td{padding:4px 6px;vertical-align:top;}
  .popup-section td:first-child{color:#4caf50;font-weight:500;width:40%;}
  @media(max-width:600px){.popup-card{width:90vw;}}
</style>
</head>
<body class="light">
<div id="map"></div>

<div class="switch-container">
  <div class="switch-item">
    ‚òÄÔ∏è
    <label class="switch">
      <input type="radio" name="mapmode" id="lightBtn" checked>
      <span class="slider"></span>
    </label>
  </div>
  <div class="switch-item">
    üåô
    <label class="switch">
      <input type="radio" name="mapmode" id="darkBtn">
      <span class="slider"></span>
    </label>
  </div>
  <div class="switch-item">
    üõ∞Ô∏è
    <label class="switch">
      <input type="radio" name="mapmode" id="satBtn">
      <span class="slider"></span>
    </label>
  </div>
</div>

<script>
const scriptURL="https://script.google.com/macros/s/AKfycbz3X15bIek1QQ2HaOfNTH55wFyZD0HLTebtYSeKtnbda2VLqTy32-uhY_R2O3X9ZmQ7RQ/exec";

const map=L.map('map').setView([-6.945702230371395, 107.6093796122096],13);
const baseLayers={
  light:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
  dark:L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'),
  sat:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
};
baseLayers.light.addTo(map);

let pelangganLayer;
async function loadData(){
  const res=await fetch(scriptURL);
  const data=await res.json();
  if(pelangganLayer) map.removeLayer(pelangganLayer);

  pelangganLayer=L.geoJSON(data,{
    pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:7,fillColor:"#4db8ff",color:"#fff",weight:1,fillOpacity:0.9}),
    onEachFeature:(f,layer)=>{
      layer.on("popupopen", async ()=>{
  const popup = layer.getPopup().getElement();
  const aduanDiv = popup.querySelector(`#aduanList-${p.ID}`);

  try {
    const res = await fetch(`${scriptURL}?mode=pengaduan&id=${p.ID}`);
    const data = await res.json();
    if(data.length === 0) {
      aduanDiv.innerHTML = "<p>Tidak ada pengaduan pelanggan ini.</p>";
    } else {
      aduanDiv.innerHTML = data.map(a=>`
        <div style="border-bottom:1px solid #ccc;padding:4px 0;">
          <b>${a.jenis}</b> <span style="color:gray;font-size:0.8em">(${a.tanggal})</span><br>
          ${a.deskripsi}<br>
          <span style="color:${a.status==='Baru'?'red':'green'}">${a.status}</span>
        </div>
      `).join("");
    }
  } catch(err){
    aduanDiv.innerHTML = "Gagal memuat data.";
  }
});

      const p=f.properties;
      const statusClass=(p["Status Billing"]||"").toLowerCase().includes("nunggak")?"tunggakan":"belum";

      // Foto Rumah (link)
      const fotoUrl = p["Foto Rumah"] || "";
      let fotoHTML = "<p>Tidak ada foto rumah.</p>";
      if (fotoUrl) {
        fotoHTML = `
          <div style="text-align:center;">
            <img src="${fotoUrl}" alt="Foto Rumah"
                 style="max-width:100%;height:140px;object-fit:cover;border-radius:8px;margin-bottom:6px;"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';" />
            <a href="${fotoUrl}" target="_blank"
               style="display:none;font-size:0.85rem;color:#007bff;">üì∑ Lihat Foto</a>
          </div>
        `;
      }

      const popupHTML=`
      <div class="popup-card">
        <div class="popup-header">
          <h3>${p.Nama||"Pelanggan"} <small>${p.ID||""}</small></h3>
          <a class="menuju-lokasi" target="_blank" href="https://www.google.com/maps?q=${p.Latitude},${p.Longtitude}">üìç Menuju Lokasi</a>
        </div>
        <div class="popup-body">
          <div class="popup-status">
            <div>Tagihan Air: <b>Rp ${p.Tagihan||0}</b></div>
            <div class="status-label ${statusClass}">${p["Status Billing"]||"Belum Terbayar"}</div>
          </div>

          <div class="popup-tab">
            <div class="tab-btn active" data-tab="detail">Pelanggan</div>
            <div class="tab-btn" data-tab="tagihan">Tagihan</div>
            <div class="tab-btn" data-tab="pengaduan">Pengaduan</div>
            <div class="tab-btn" data-tab="foto">Foto</div>
          </div>

          <div class="popup-section active" id="detail">
            <table>
              <tr><td>Golongan</td><td>${p.Golongan||"-"}</td></tr>
              <tr><td>Status</td><td>${p["Status Planggan"]||"-"}</td></tr>
              <tr><td>Alamat</td><td>${p.Alamat||"-"}</td></tr>
              <tr><td>Kelurahan</td><td>${p.Kelurahan||"-"}</td></tr>
              <tr><td>Kecamatan</td><td>${p.Kecamatan||"-"}</td></tr>
              <tr><td>Kota/Kabupaten</td><td>${p["Wilayah Pelayanan"]||"-"}</td></tr>
            </table>
          </div>

          <div class="popup-section" id="tagihan">
            <table>
              <tr><td>Tagihan</td><td>Rp ${p.Tagihan||0}</td></tr>
              <tr><td>Pemakaian</td><td>${p.Pemakaian||0} m¬≥</td></tr>
              <tr><td>Status Billing</td><td>${p["Status Billing"]||"-"}</td></tr>
              <tr><td>Tunggakan</td><td>Rp ${p.Tunggakan||0}</td></tr>
              <tr><td>Due Date</td><td>${p["Due Date"]||"-"}</td></tr>
              <tr><td>Tanggal Bayar</td><td>${p["Tanggal Bayar"]||"-"}</td></tr>
              <tr><td>Loket Bayar</td><td>${p["Loket Bayar"]||"-"}</td></tr>
            </table>
          </div>

         <div class="popup-section" id="pengaduan">
  <div id="aduanList-${p.pengaduan}">Memuat data pengaduan...</div>
</div>

          <div class="popup-section" id="foto">
            ${fotoHTML}
          </div>
        </div>
      </div>`;

      layer.bindPopup(popupHTML);
      layer.on("popupopen", async ()=>{
  const popup = layer.getPopup().getElement();
  const aduanDiv = popup.querySelector(`#aduanList-${p.pengaduan}`);
  try {
    const res = await fetch(`${scriptURL}?mode=pengaduan&id=${p.pengaduan}`);
    const data = await res.json();
    if(data.length === 0) {
      aduanDiv.innerHTML = "<p>Tidak ada pengaduan pelanggan ini.</p>";
    } else {
      aduanDiv.innerHTML = data.map(a=>`
        <div style="border-bottom:1px solid #ccc;padding:4px 0;">
          <b>${a.jenis}</b> (${a.tanggal})<br>
          ${a.deskripsi}<br>
          <span style="color:${a.status==='Baru'?'red':'green'}">${a.status}</span>
        </div>
      `).join("");
    }
  } catch(err){
    aduanDiv.innerHTML = "Gagal memuat data.";
  }
});

      layer.on("popupopen",()=>{
        const popup=layer.getPopup().getElement();
        const tabs=popup.querySelectorAll(".tab-btn");
        const sections=popup.querySelectorAll(".popup-section");
        tabs.forEach(btn=>{
          btn.addEventListener("click",()=>{
            tabs.forEach(b=>b.classList.remove("active"));
            btn.classList.add("active");
            sections.forEach(s=>s.classList.remove("active"));
            popup.querySelector(`#${btn.dataset.tab}`).classList.add("active");
          });
        });
      });
    }
  }).addTo(map);
  map.fitBounds(pelangganLayer.getBounds());
}
loadData();

// switch
const lightBtn=document.getElementById('lightBtn');
const darkBtn=document.getElementById('darkBtn');
const satBtn=document.getElementById('satBtn');
const allBtns=[lightBtn,darkBtn,satBtn];
function setActive(btn){allBtns.forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
function setBase(mode,btn){
  for(let key in baseLayers){if(map.hasLayer(baseLayers[key])) map.removeLayer(baseLayers[key]);}
  setActive(btn);
  if(mode==="light"){baseLayers.light.addTo(map);document.body.className="light";}
  else if(mode==="dark"){baseLayers.dark.addTo(map);document.body.className="dark";}
  else{baseLayers.sat.addTo(map);document.body.className="light";}
}
lightBtn.onclick=()=>setBase("light",lightBtn);
darkBtn.onclick=()=>setBase("dark",darkBtn);
satBtn.onclick=()=>setBase("sat",satBtn);
</script>
</body>
</html>
