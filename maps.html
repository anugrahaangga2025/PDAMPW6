<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peta Pelanggan PDAM</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html,body{height:100%;margin:0;font-family:"Poppins",sans-serif;transition:background 0.3s ease;}
  body.light{background:#eef2f7;color:#111;}
  body.dark{background:#0b1f3b;color:#fff;}
  #map{height:100%;width:100%;}

  /* switch kiri */
  .switch-container{position:absolute;top:80px;left:10px;z-index:1000;display:flex;flex-direction:column;gap:6px;
    background:rgba(255,255,255,0.9);border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.3);padding:6px;}
  body.dark .switch-container{background:rgba(0,0,0,0.7);}
  .switch-btn{background:transparent;border:none;font-size:1rem;cursor:pointer;border-radius:8px;padding:4px 8px;color:#222;}
  .switch-btn.active{background:#007bff;color:#fff;}
  body.dark .switch-btn{color:#fff;}

  /* Popup card */
  .popup-card{width:320px;background:#fff;border-radius:12px;overflow:hidden;
    box-shadow:0 4px 10px rgba(0,0,0,0.3);color:#000;font-size:0.85rem;}
  body.dark .popup-card{background:#10233f;color:#f2f2f2;}
  .popup-header{padding:10px 12px 4px;border-bottom:1px solid #ddd;}
  .popup-header h3{margin:0;font-size:1.05rem;font-weight:600;}
  .popup-header small{color:#777;}
  .menuju-lokasi{display:inline-block;font-size:0.75rem;background:#c5f6c5;color:#2e7d32;border-radius:20px;
    padding:3px 10px;margin-top:4px;text-decoration:none;}
  .popup-body{padding:10px 12px;}
  .popup-status{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
  .status-label{padding:2px 8px;border-radius:10px;font-size:0.75rem;color:#fff;}
  .sudah{background:#00f43d;}
  .tunggakan{background:#d93025;}
  .popup-tab{display:flex;border-bottom:1px solid #ccc;font-size:0.8rem;margin-bottom:6px;}
  .popup-tab div{flex:1;text-align:center;padding:6px 0;cursor:pointer;}
  .popup-tab div.active{color:#4caf50;font-weight:600;border-bottom:2px solid #4caf50;}
  .popup-section{display:none;}
  .popup-section.active{display:block;}
  .popup-section table{width:100%;border-collapse:collapse;font-size:0.8rem;}
  .popup-section td{padding:4px 6px;vertical-align:top;}
  .popup-section td:first-child{color:#4caf50;font-weight:500;width:40%;}
  @media(max-width:600px){.popup-card{width:90vw;}}

  /* search kanan atas */
  .search-box {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 9999;
    background: rgba(255,255,255,0.95);
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .search-box input {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 5px 8px;
    width: 180px;
  }
  .search-box button {
    background: #007bff;
    border: none;
    color: #fff;
    border-radius: 4px;
    padding: 6px 10px;
    cursor: pointer;
  }
  .search-box button:hover {
    background: #0056b3;
  }
</style>
</head>
<body class="light">

<!-- üîç Search pelanggan -->
<div class="search-box">
  <input type="text" id="searchNama" placeholder="Cari nama pelanggan..." />
  <button id="btnCari">Cari</button>
</div>

<div id="map"></div>

<div class="switch-container">
  <div class="switch-item"><input type="radio" name="mapmode" id="lightBtn" checked></div>
  <div class="switch-item"><input type="radio" name="mapmode" id="darkBtn"></div>
  <div class="switch-item"><input type="radio" name="mapmode" id="satBtn"></div>
</div>

<script>
  // üî¢ Format angka ke Rupiah
function formatRupiah(angka) {
  if (!angka || isNaN(angka)) return "Rp 0";
  return "Rp " + Number(angka).toLocaleString("id-ID");
}
const scriptURL="https://script.google.com/macros/s/AKfycbydEXwuG8sG4x4nsWb4VV3M8rMXWdXAyhiq287d47fr_WSis0-Boht7_pxQF1dlGeqf0Q/exec?mode=pelanggan";
const map=L.map('map').setView([-6.9457,107.6093],13);
const baseLayers={
  light:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
  dark:L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'),
  sat:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')
};
baseLayers.light.addTo(map);

let pelangganLayer;
const markers = []; // üü¢ array global untuk semua marker pelanggan

async function loadData(){
  const res=await fetch(scriptURL);
  const data=await res.json();
  if(pelangganLayer) map.removeLayer(pelangganLayer);

  pelangganLayer=L.geoJSON(data,{
    pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:7,fillColor:"#4db8ff",color:"#fff",weight:1,fillOpacity:0.9}),
    onEachFeature:(f,layer)=>{
      const p=f.properties;
      const statusClass=(p["Status Planggan"]||"").toLowerCase().includes("nunggak")?"tunggakan":"sudah";
      

      const popupHTML=`
        <div class="popup-card">
          <div class="popup-header">
            <h3>${p.Nama||"Pelanggan"} <small>${p.ID||""}</small></h3>
            <a class="menuju-lokasi" target="_blank" href="https://www.google.com/maps?q=${p.Latitude},${p.Longtitude}">üìç Menuju Lokasi</a>
          </div>
          <div class="popup-body">
            <div class="popup-status">
              <div>Pemakaian: <b>${formatMeterKubik(p.Pemakaian)}</b></div>
              <div class="status-label ${statusClass}">${p["Status Planggan"]||"Belum Terbayar"}</div>
              
            </div>
            <div class="popup-tab">
              <div class="tab-btn active" data-tab="detail">Pelanggan</div>
              <div class="tab-btn" data-tab="tagihan">Tagihan</div>
              <div class="tab-btn" data-tab="foto">Foto</div>
            </div>
            <div class="popup-section active" id="detail">
              <table>
                <tr><td>Alamat</td><td>${p.Alamat||"-"}</td></tr>
                <tr><td>Kelurahan</td><td>${p.Kelurahan||"-"}</td></tr>
                <tr><td>Kecamatan</td><td>${p.Kecamatan||"-"}</td></tr>
              </table>
            </div>
            <div class="popup-section" id="tagihan">
              <table>
                <tr><td>Tagihan</td><td>${formatRupiah(p.Tagihan)}</td></tr>
                <tr><td>Status</td><td>${p.StatusBilling||"-"}</td></tr>
                <tr><td>Tunggakan</td><td>${formatRupiah(p.Tunggakan)}</td></tr>
                <tr><td>Keterangan Cater</td><td>${p.Ketcatat||"-"}</td></tr>

              </table>
            </div>
            <div class="popup-section" id="foto">
              ${p["Foto Rumah"]?`<img src="${p["Foto Rumah"]}" style="width:100%;border-radius:8px;">`:"<p>Tidak ada foto.</p>"}
            </div>
          </div>
        </div>`;
      layer.bindPopup(popupHTML);

      // üü¢ simpan nama ke marker
      if (p.Nama) {
        layer.nama = p.Nama.toLowerCase();
        markers.push(layer);
      }

      // aktifkan tab popup
      layer.on("popupopen",()=>{
        const popup=layer.getPopup().getElement();
        const tabs=popup.querySelectorAll(".tab-btn");
        const sections=popup.querySelectorAll(".popup-section");
        tabs.forEach(btn=>{
          btn.addEventListener("click",()=>{
            tabs.forEach(b=>b.classList.remove("active"));
            btn.classList.add("active");
            sections.forEach(s=>s.classList.remove("active"));
            popup.querySelector(`#${btn.dataset.tab}`).classList.add("active");
          });
        });
      });
    }
  }).addTo(map);
  map.fitBounds(pelangganLayer.getBounds());
// üî¢ Format angka ke satuan m¬≥ (meter kubik)
function formatMeterKubik(angka) {
  if (!angka || isNaN(angka)) return "0 m¬≥";
  return Number(angka).toLocaleString("id-ID") + " m¬≥";
}
}
loadData();

// üü¢ SEARCH NAMA PELANGGAN
function cariNama() {
  const input = document.getElementById("searchNama").value.toLowerCase();
  if (!input) return;
  const found = markers.find(m => m.nama && m.nama.includes(input));
  if (found) {
    map.flyTo(found.getLatLng(), 17, { duration: 1.2 });
    found.openPopup();
  } else {
    alert("Nama pelanggan tidak ditemukan!");
  }
}
document.getElementById("btnCari").addEventListener("click", cariNama);
document.getElementById("searchNama").addEventListener("keypress", e => {
  if (e.key === "Enter") cariNama();
});

// switch layer
const lightBtn=document.getElementById('lightBtn');
const darkBtn=document.getElementById('darkBtn');
const satBtn=document.getElementById('satBtn');
const allBtns=[lightBtn,darkBtn,satBtn];
function setBase(mode,btn){
  for(let key in baseLayers){if(map.hasLayer(baseLayers[key])) map.removeLayer(baseLayers[key]);}
  if(mode==="light"){baseLayers.light.addTo(map);document.body.className="light";}
  else if(mode==="dark"){baseLayers.dark.addTo(map);document.body.className="dark";}
  else{baseLayers.sat.addTo(map);document.body.className="light";}
}
lightBtn.onclick=()=>setBase("light",lightBtn);
darkBtn.onclick=()=>setBase("dark",darkBtn);
satBtn.onclick=()=>setBase("sat",satBtn);
// üïí AUTO REFRESH SETIAP 1 MENIT TANPA TAMPILAN
setInterval(() => {
  console.log("‚ü≥ Auto-refresh data pelanggan...");
  loadData(); // panggil ulang data
}, 60000); // 60000 ms = 1 menit

</script>
<!-- üîî Tambah elemen suara & toast -->
<audio id="notifSound" preload="auto">
  <source src="https://assets.mixkit.co/sfx/download/mixkit-correct-answer-tone-2870.wav" type="audio/wav">
</audio>

<style>
/* Toast Notification Style */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #0078FF;
  color: white;
  padding: 12px 18px;
  border-radius: 8px;
  font-family: "Poppins", sans-serif;
  font-size: 13px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.4s ease;
  z-index: 9999;
}
.toast.show {
  opacity: 1;
  transform: translateY(0);
}

/* Blinking marker */
.blink-marker {
  animation: blink 1.5s infinite ease-in-out;
}
@keyframes blink {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.2); }
}
</style>

<script>
// üîπ Global untuk simpan tiket baru
let shownTickets = new Set();

// üîπ Fungsi buat tampilkan toast
function showToast(message) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add("show"), 100);
  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 500);
  }, 4000);
}

// üîπ Fungsi main popup aduan
function popupAduan(p) {
  const status = p.Status || "Baru";
  const statusClass =
    status === "Baru" ? "status-baru" :
    status === "Proses" ? "status-proses" :
    "status-selesai";
  const id = p.Tiket || Math.random().toString(36).substring(2,7);

  return `
    <div class="${status === "Baru" ? "blink-marker" : ""}">
      <div class="popup-card">
        <div class="popup-header" style="display:flex;justify-content:space-between;align-items:center;">
          <h3 style="margin:0;font-size:15px;color:#0078FF;">
            ${p["Nama Pelanggan"] || "Pelanggan"}
            <small style="color:#999;font-size:12px;">${p.Tiket || ""}</small>
          </h3>
          <a href="https://www.google.com/maps?q=${p["Lokasi Gangguan"]}"
             target="_blank"
             style="font-size:12px;color:#0078FF;text-decoration:none;">üìç Lokasi</a>
        </div>

        <div class="popup-tabs" style="display:flex;margin-top:8px;border:1px solid #ddd;border-radius:6px;overflow:hidden;">
          <div class="popup-tab-btn active" data-tab="detail-${id}" style="flex:1;text-align:center;font-size:12px;padding:4px;cursor:pointer;">üßæ Detail</div>
          <div class="popup-tab-btn" data-tab="keterangan-${id}" style="flex:1;text-align:center;font-size:12px;padding:4px;cursor:pointer;">üí¨ Keterangan</div>
        </div>

        <div id="detail-${id}" class="popup-content">
          <p style="margin:2px 0 8px 0;color:#777;font-size:12px;font-style:italic;">
          ${p.Tanggal ? new Date(p.Tanggal).toLocaleString("id-ID", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
          timeZone: "Asia/Jakarta"
        }) + " WIB"
      : "-"
  } <span style="padding:3px 8px;border-radius:6px;font-size:12px;font-weight:600;
              background:${
                status==="Baru"?"#ffebee":status==="Proses"?"#fff6da":"#e8f5e9"
              };
              color:${
                status==="Baru"?"#e53935":status==="Proses"?"#f9a825":"#2e7d32"
              };">${status}</span>
</p>
          <div><b>Jenis Keluhan:</b> ${p["Jenis Keluhan"] || "-"}</div>
           <div><b>NoLan:</b> ${p["NomorPelanggan"] || "-"}</div>
          <div><b>Telpon:</b> ${p["Nomor Kontak"] || "-"}</div>
          <div><b>Alamat:</b> ${p["Alamat"] || "-"}</div>
        </div>

        <div id="keterangan-${id}" class="popup-content hide" style="display:none;">
          <b>Keluhan:</b><br>
          <div style="white-space:pre-wrap;margin-bottom:6px;">${p["Keterangan"] || "-"}</div>
          ${
            p["Dokumentasi Pengaduan"]
              ? `<img src="${p["Dokumentasi Pengaduan"]}" style="width:100%;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.15);">`
              : `<p style="font-size:12px;color:#888;text-align:center;">Tidak ada foto</p>`
          }
        </div>
      </div>
    </div>
    <script>
      document.querySelectorAll('.popup-tab-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const tabId=btn.getAttribute('data-tab');
          const parent=btn.closest('.popup-card');
          parent.querySelectorAll('.popup-tab-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          parent.querySelectorAll('.popup-content').forEach(c=>c.style.display='none');
          parent.querySelector('#'+tabId).style.display='block';
        });
      });
    <\/script>
  `;
}

// üîπ Fungsi load data pengaduan
async function loadAduan() {
  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbz5ZFftu5HERETjyT25WSdIbz8Va0zqoCv4We3OpDIqi09vpWEO7814ZE2Llu2dNj5kJA/exec?mode=aduan");
    const data = await res.json();
    data.sort((a,b)=>new Date(a.Tanggal)-new Date(b.Tanggal));

    if(window.aduanLayer) map.removeLayer(window.aduanLayer);
    window.aduanLayer = L.layerGroup().addTo(map);

    const audio = document.getElementById("notifSound");

    data.forEach(p=>{
      const lokasi = p["Lokasi Gangguan"];
      const status = p.Status || "";
      if(!lokasi || status==="Selesai") return;

      const [lat,lng] = lokasi.split(",").map(Number);
      if(isNaN(lat)||isNaN(lng)) return;

      // üîî Deteksi tiket baru
      if(!shownTickets.has(p.Tiket)){
        shownTickets.add(p.Tiket);
        if(status==="Baru"){
          audio.currentTime = 0;
          audio.play().catch(()=>{});
          showToast(`üîî Aduan baru: ${p["Nama Pelanggan"] || "Pelanggan"} (${p.Tiket})`);
        }
      }

      const warna = status==="Baru"?"#ff3333":status==="Proses"?"#FFD93D":"#2ECC71";
      const iconHTML = `
        <div class="${status==="Baru"?"blink-marker":""}"
             style="width:18px;height:18px;background:${warna};
             border:2px solid #fff;border-radius:50%;
             box-shadow:0 0 6px rgba(0,0,0,0.4);">
        </div>`;

      const marker = L.marker([lat,lng],{
        icon:L.divIcon({className:"",html:iconHTML,iconSize:[18,18],iconAnchor:[9,9]})
      }).addTo(window.aduanLayer);

      marker.bindPopup(popupAduan(p));
      if(status==="Baru") marker.openPopup();
    });

  } catch(err){
    console.error("‚ùå Gagal memuat data:",err);
  }
}

loadAduan();

// === Aktifin tab Detail / Keterangan di setiap popup ===
map.on("popupopen", (e) => {
  const popupNode = e.popup.getElement();
  if (!popupNode) return;

  const btns = popupNode.querySelectorAll(".popup-tab-btn");
  btns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const tabId = btn.getAttribute("data-tab");
      const parent = btn.closest(".popup-card");
      if (!parent) return;

      // nonaktifin semua tombol
      parent.querySelectorAll(".popup-tab-btn").forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");

      // sembunyikan semua isi tab
      parent.querySelectorAll(".popup-content").forEach((c) => (c.style.display = "none"));
      const showTab = parent.querySelector(`#${tabId}`);
      if (showTab) showTab.style.display = "block";
    });
  });
});


setInterval(loadAduan, 30000);
</script>


</body>
</html>
