<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Pengaduan PDAM</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #f4f6f9; font-family: "Poppins", sans-serif; }
    .navbar { background: #0d2a57; }
    .navbar-brand, .nav-link { color: #fff !important; font-weight: 500; }
    .table thead { background: #0d2a57; color: white; }
    td select { border: 1px solid #ccc; border-radius: 4px; padding: 2px 6px; }
    .status-Baru { background: #fff3cd; }
    .status-Proses { background: #cfe2ff; }
    .status-Selesai { background: #d1e7dd; }
    #refreshInfo { font-size: 13px; color: #6c757d; text-align: right; }
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
    }
  </style>
</head>

<body>
  <!-- üîπ NAVBAR -->
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a href="index.html" class="navbar-brand d-flex align-items-center">
      <img src="https://perumdatirtawening.co.id/asset/image/logo-horizon-kecils.gif" width="160">
    </a>
      <div class="d-flex">
        <a class="btn btn-light btn-sm" href="index.html">üè†</a>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4 class="text-primary">üìã Data Pengaduan Pelanggan</h4>
      <div class="d-flex align-items-center gap-2">
        <select id="statusFilter" class="form-select form-select-sm">
          <option value="all">Tampilkan Semua</option>
          <option value="Baru">Belum Ditangani (Baru)</option>
          <option value="Proses">Sedang Proses</option>
          <option value="Selesai">Sudah Selesai</option>
        </select>
        <span id="refreshInfo">Auto refresh setiap 30 detik ‚è≥</span>
      </div>
    </div>

    <!-- üîπ TABEL PENGADUAN -->
    <div class="table-responsive">
      <table class="table table-bordered align-middle text-center" id="pengaduanTable">
        <thead>
          <tr>
            <th>Tiket</th>
            <th>Tanggal</th>
            <th>Jenis</th>
            <th>No. Pelanggan</th>
            <th>Nama</th>
            <th>Alamat</th>
            <th>Kontak</th>
            <th>Keterangan</th>
            <th>Lokasi</th>
            <th>Foto</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h4 class="mt-5 mb-3 text-primary">üìà Rekap Pengaduan Mingguan</h4>
    <canvas id="chartRekap" height="120"></canvas>
  </div>

  <!-- üîπ Toast Notification -->
  <div class="toast-container"></div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz5BaQOUHGv_B9wHAraZB3vtbxBwnKgATsXvfb0WpwQ9NYausrgsfusi4LHlvxLFzfs3Q/exec";
    let allData = [];
    let chartInstance = null;

    async function loadPengaduan(showToast = true) {
      const res = await fetch(`${SCRIPT_URL}?mode=aduan`);
      allData = await res.json();
      renderTable(allData);
      drawChart(allData);

      const now = new Date().toLocaleTimeString("id-ID");
      document.getElementById("refreshInfo").textContent = "Terakhir diperbarui: " + now;

      if (showToast) showNotification(`‚úÖ Data diperbarui otomatis ‚Äî ${now}`);
    }

    function renderTable(data) {
      const filter = document.getElementById("statusFilter").value;
      const tbody = document.querySelector("#pengaduanTable tbody");
      tbody.innerHTML = "";

      const filtered = data.filter(d => filter === "all" || d.Status === filter);

      filtered.forEach(d => {
        const row = document.createElement("tr");
        row.classList.add(`status-${d.Status || 'Baru'}`);

        row.innerHTML = `
          <td>${d.Tiket}</td>
          <td>${d.Tanggal}</td>
          <td>${d.Jenis}</td>
          <td>${d["Nomor Pelanggan"]}</td>
          <td>${d["Nama Pelanggan"]}</td>
          <td>${d.Alamat}</td>
          <td>${d["Nomor Kontak"]}</td>
          <td>${d.Keterangan}</td>
          <td><a href="https://www.google.com/maps?q=${d.Lokasi}" target="_blank">üìç</a></td>
          <td>${d.Dokumentasi ? `<a href="${d.Dokumentasi}" target="_blank">üñºÔ∏è</a>` : "-"}</td>
          <td>
            <select onchange="updateStatus('${d.Tiket}', this.value)" class="form-select form-select-sm">
              <option ${d.Status === "Baru" ? "selected" : ""}>Baru</option>
              <option ${d.Status === "Proses" ? "selected" : ""}>Proses</option>
              <option ${d.Status === "Selesai" ? "selected" : ""}>Selesai</option>
            </select>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function updateStatus(tiket, status) {
      await fetch(`${SCRIPT_URL}?mode=update&tiket=${tiket}&status=${status}`);
      loadPengaduan(false);
    }

    function drawChart(data) {
      const ctx = document.getElementById("chartRekap");
      const weekly = { Baru: 0, Proses: 0, Selesai: 0 };
      data.forEach(d => weekly[d.Status] = (weekly[d.Status] || 0) + 1);

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Baru", "Proses", "Selesai"],
          datasets: [{
            label: "Jumlah Aduan",
            data: [weekly.Baru || 0, weekly.Proses || 0, weekly.Selesai || 0],
            backgroundColor: ["#fff3cd", "#cfe2ff", "#d1e7dd"]
          }]
        },
        options: { plugins: { legend: { display: false } } }
      });
    }

    function showNotification(msg) {
      const container = document.querySelector(".toast-container");
      const toast = document.createElement("div");
      toast.className = "toast align-items-center text-bg-primary border-0 show";
      toast.role = "alert";
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${msg}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    document.getElementById("statusFilter").addEventListener("change", () => renderTable(allData));
    setInterval(() => loadPengaduan(), 30000);

    loadPengaduan();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
